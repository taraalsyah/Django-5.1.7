{% extends "base.html" %}
{% load static %}

{% block title %}
<title>User Management</title>
{% endblock title %}

{% block app_css %}
{{ block.super }}
{% include "ticket/snippets/styles.html" %}
<style>
    .table-wrapper {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th,
    td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }

    th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #444;
    }

    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 500;
    }

    .status-active {
        background-color: #e8f5e9;
        color: #1b5e20;
    }

    .status-inactive {
        background-color: #ffebee;
        color: #c62828;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 20px;
        border-radius: 8px;
        width: 400px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }

    .close {
        font-size: 24px;
        cursor: pointer;
        color: #666;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }

    .form-group input[readonly] {
        background-color: #f5f5f5;
        cursor: not-allowed;
    }
</style>
{% endblock app_css %}

{% block content %}
<div class="reporting-container" style="padding: 20px;">
    <h2>User Management</h2>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Full Name</th>
                    <th>Role (Groups)</th>
                    <th>Update Role</th>
                    <th>Status</th>
                    <th>Date Joined</th>
                    <th>Last Login</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr id="user-row-{{ u.id }}">
                    <td>
                        {{ u.username }}
                        {% if u.is_superuser %}
                        <span class="status-badge"
                            style="background-color: #f3e5f5; color: #7b1fa2; font-size: 0.7em;">Superuser</span>
                        {% endif %}
                    </td>
                    <td>{{ u.email }}</td>
                    <td>{{ u.get_full_name }}</td>
                    <td>
                        <span id="role-text-{{ u.id }}" class="role-display">
                            {% for group in u.groups.all %}
                            {{ group.name }}{% if not forloop.last %}, {% endif %}
                            {% empty %}
                            -
                            {% endfor %}
                        </span>
                    </td>
                    <td>
                        <select class="role-select" data-user-id="{{ u.id }}"
                            data-current-role="{% for group in u.groups.all %}{{ group.name }}{% empty %}None{% endfor %}"
                            style="padding: 4px; border-radius: 4px; border: 1px solid #ccc;">
                            {% for roles in groups %}
                            <option value="{{roles.name}}">{{roles.name}}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td id="status-cell-{{ u.id }}">
                        {% if u.is_active %}
                        <span class="status-badge status-active">Active</span>
                        {% else %}
                        <span class="status-badge status-inactive">Inactive</span>
                        {% endif %}
                    </td>
                    <td>{{ u.date_joined|date:"Y-m-d H:i" }}</td>
                    <td>{{ u.last_login|date:"Y-m-d H:i"|default:"-" }}</td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <button class="edit-user-btn" data-user-id="{{ u.id }}"
                                style="padding: 4px 8px; background-color: #ffc107; color: #000; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                                Edit
                            </button>
                            {% if u != request.user %}
                            <button class="toggle-status-btn" data-user-id="{{ u.id }}" data-username="{{ u.username }}"
                                data-active="{{ u.is_active|yesno:'true,false' }}"
                                style="padding: 4px 8px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                                {{ u.is_active|yesno:'Deactivate,Activate' }}
                            </button>
                            <button class="delete-user-btn" data-user-id="{{ u.id }}" data-username="{{ u.username }}"
                                style="padding: 4px 8px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                                Delete
                            </button>
                            {% else %}
                            <span style="color: #999; font-size: 0.85em; padding-top: 4px;">-</span>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" style="text-align:center; padding: 20px;">No users found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="pagination-container" style="margin-top: 20px; display: flex; justify-content: center;">
        <ul class="pagination" style="display: flex; list-style: none; gap: 5px;">
            {% if page_obj.has_previous %}
            <li><a href="?page={{ page_obj.previous_page_number }}" class="btn-primary"
                    style="padding: 5px 10px; background-color: #007bff; color: white; border-radius: 4px; text-decoration: none;">Prev</a>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li><span class="btn-primary"
                    style="background-color: #0056b3; color: white; padding: 5px 10px; border-radius: 4px;">{{ num
                    }}</span></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <li><a href="?page={{ num }}"
                    class="btn-primary"
                    style="background-color: #f8f9fa; color: #333; border: 1px solid #ddd; padding: 5px 10px; border-radius: 4px; text-decoration: none;">{{
                    num }}</a></li>
                {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li><a href="?page={{ page_obj.next_page_number }}" class="btn-primary"
                        style="padding: 5px 10px; background-color: #007bff; color: white; border-radius: 4px; text-decoration: none;">Next</a>
                </li>
                {% endif %}
        </ul>
    </div>
    {% endif %}

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit User</h3>
                <span class="close">&times;</span>
            </div>
            <form id="editUserForm">
                <input type="hidden" id="edit-user-id">
                <div class="form-group">
                    <label for="edit-username">Username</label>
                    <input type="text" id="edit-username" required>
                </div>
                <div class="form-group">
                    <label for="edit-email">Email</label>
                    <input type="email" id="edit-email" readonly>
                </div>
                <div class="form-group">
                    <label for="edit-first-name">First Name</label>
                    <input type="text" id="edit-first-name">
                </div>
                <div class="form-group">
                    <label for="edit-last-name">Last Name</label>
                    <input type="text" id="edit-last-name">
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn-secondary close-modal"
                        style="padding: 8px 16px; border-radius: 4px; border: 1px solid #ccc; background: #eee; cursor: pointer;">Cancel</button>
                    <button type="submit" class="btn-primary"
                        style="padding: 8px 16px; border-radius: 4px; border: none; background: #007bff; color: white; cursor: pointer;">Save
                        Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Initialize role selects
    document.querySelectorAll('.role-select').forEach(select => {
        const currentRole = select.getAttribute('data-current-role');
        if (currentRole && currentRole !== 'None') {
            select.value = currentRole;
        } else {
            select.value = 'None';
        }
    });

    document.querySelectorAll('.role-select').forEach(select => {
        select.addEventListener('change', function () {
            const userId = this.getAttribute('data-user-id');
            const newRole = this.value;
            const previousRole = this.getAttribute('data-current-role');
            const roleTextSpan = document.getElementById(`role-text-${userId}`);

            if (confirm(`Are you sure you want to change this user's role to ${newRole}?`)) {
                fetch('{% url "ticket:update_user_role" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        role: newRole
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            roleTextSpan.textContent = newRole === 'None' ? '-' : newRole;
                            this.setAttribute('data-current-role', newRole);
                            alert('Role updated successfully');
                        } else {
                            alert('Error updating role: ' + data.error);
                            this.value = previousRole; // Revert selection
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while updating the role.');
                        this.value = previousRole; // Revert selection
                    });
            } else {
                this.value = previousRole; // Revert selection
            }
        });
    });

    // Edit User Modal Logic
    const editModal = document.getElementById('editUserModal');
    const editForm = document.getElementById('editUserForm');
    const closeBtns = document.querySelectorAll('.close, .close-modal');

    document.querySelectorAll('.edit-user-btn').forEach(button => {
        button.addEventListener('click', function () {
            const userId = this.getAttribute('data-user-id');

            // Fetch user data
            fetch(`{% url "ticket:edit_user" %}?user_id=${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('edit-user-id').value = data.user.id;
                        document.getElementById('edit-username').value = data.user.username;
                        document.getElementById('edit-email').value = data.user.email;
                        document.getElementById('edit-first-name').value = data.user.first_name;
                        document.getElementById('edit-last-name').value = data.user.last_name;
                        editModal.style.display = 'block';
                    } else {
                        alert('Error fetching user data: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while fetching user data.');
                });
        });
    });

    editForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const userId = document.getElementById('edit-user-id').value;
        const row = document.getElementById(`user-row-${userId}`);
        const usernameCell = row.cells[0];
        const emailCell = row.cells[1];
        const fullNameCell = row.cells[2];

        const formData = {
            user_id: userId,
            username: document.getElementById('edit-username').value,
            email: document.getElementById('edit-email').value,
            first_name: document.getElementById('edit-first-name').value,
            last_name: document.getElementById('edit-last-name').value,
        };

        fetch('{% url "ticket:edit_user" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User updated successfully.');
                    // Update table row
                    usernameCell.innerHTML = formData.username +
                        (usernameCell.querySelector('.status-badge') ? ' ' + usernameCell.querySelector('.status-badge').outerHTML : '');
                    emailCell.textContent = formData.email;
                    fullNameCell.textContent = data.full_name;

                    editModal.style.display = 'none';
                } else {
                    alert('Error updating user: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the user.');
            });
    });

    closeBtns.forEach(btn => {
        btn.onclick = function () {
            editModal.style.display = 'none';
        }
    });

    window.onclick = function (event) {
        if (event.target == editModal) {
            editModal.style.display = 'none';
        }
    }

    document.querySelectorAll('.delete-user-btn').forEach(button => {
        button.addEventListener('click', function () {
            const userId = this.getAttribute('data-user-id');
            const username = this.getAttribute('data-username');
            const row = document.getElementById(`user-row-${userId}`);

            if (confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
                fetch('{% url "ticket:delete_user" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        user_id: userId
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(`User "${username}" deleted successfully.`);
                            row.remove();
                        } else {
                            alert('Error deleting user: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the user.');
                    });
            }
        });
    });

    document.querySelectorAll('.toggle-status-btn').forEach(button => {
        button.addEventListener('click', function () {
            const userId = this.getAttribute('data-user-id');
            const username = this.getAttribute('data-username');
            const isActive = this.getAttribute('data-active') === 'true';
            const statusCell = document.getElementById(`status-cell-${userId}`);
            const actionText = isActive ? 'deactivate' : 'activate';

            if (confirm(`Are you sure you want to ${actionText} user "${username}"?`)) {
                fetch('{% url "ticket:toggle_user_status" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        user_id: userId
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(`User "${username}" ${data.is_active ? 'activated' : 'deactivated'} successfully.`);
                            // Update status badge
                            statusCell.innerHTML = data.is_active ?
                                '<span class="status-badge status-active">Active</span>' :
                                '<span class="status-badge status-inactive">Inactive</span>';

                            // Update button
                            this.setAttribute('data-active', data.is_active);
                            this.textContent = data.is_active ? 'Deactivate' : 'Activate';
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while toggling user status.');
                    });
            }
        });
    });
</script>
{% endblock content %}